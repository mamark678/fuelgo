rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(ownerId) {
      return isSignedIn() && request.auth.uid == ownerId;
    }

    function isAdmin() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin';
    }

    // --- Users ---
    match /users/{userId} {
      // FIXED: Allow any authenticated user to read basic profile info
      // This enables displaying profile pictures and names in comments/ratings
      allow read: if isOwner(userId)
        || (isSignedIn() && resource != null && resource.data.email == request.auth.token.email)
        || isSignedIn()  // ← ADDED: Allow authenticated users to read other profiles
        || (request.query != null && 
            request.query.limit != null &&
            request.query.limit <= 1)
        || isAdmin();

      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['name', 'email'])
        && request.resource.data.name is string
        && request.resource.data.email is string
        && request.resource.data.email == request.auth.token.email;

      // FIXED: Added 'name', 'location', 'photoBase64' to allowed update fields
      allow update: if isOwner(userId)
        || isAdmin()
        || (isSignedIn() 
            && request.auth.uid == userId 
            && resource != null
            && (
              (request.resource.data.diff(resource.data).affectedKeys().hasAny([
                  'documentsSubmitted', 'emailVerified', 'photoURL', 
                  'stationName', 'stationId', 'stationLat', 'stationLng',
                  'submittedAt', 'verifiedAt', 'authProvider', 'linkedProviders',
                  'googleLinked', 'tempPasswordUsed', 'pendingDocuments',
                  'documentImages', 'documentUrls', 'resubmittedAt', 
                  'resubmissionCount', 'approvalStatus', 'favorites',
                  'assignedStations', 'lastUpdated', 'name', 'location', 'photoBase64'  // ← ADDED these fields
                ]))
              || (request.resource.data.email == request.auth.token.email)
            ));

      allow delete: if isOwner(userId) || isAdmin();

      match /claimed_offers/{claimId} {
        // User can read their own claimed offers
        allow read: if isSignedIn() && request.auth.uid == userId;
        
        // Admin can read all claimed offers
        allow read: if isAdmin();
        
        // User can create claimed offers for themselves
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.offerId is string
          && request.resource.data.offerId != ''
          && request.resource.data.userId is string
          && request.resource.data.userId == userId
          && request.resource.data.claimedAt is timestamp;
        
        // User can delete their own claimed offers
        allow delete: if isSignedIn() && request.auth.uid == userId;
        
        // Admin can delete any claimed offers
        allow delete: if isAdmin();
      }

      match /redeemed_vouchers/{redeemedId} {
        // User can read their own redeemed vouchers
        allow read: if isSignedIn() && request.auth.uid == userId;
        
        // Admin can read all redeemed vouchers
        allow read: if isAdmin();
        
        // User can create redeemed vouchers for themselves
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.voucherId is string
          && request.resource.data.voucherId != ''
          && request.resource.data.userId is string
          && request.resource.data.userId == userId
          && request.resource.data.redeemedAt is timestamp;
        
        // User can delete their own redeemed vouchers
        allow delete: if isSignedIn() && request.auth.uid == userId;
        
        // Admin can delete any redeemed vouchers
        allow delete: if isAdmin();
      }
    }

    // --- Gas stations ---
    match /gas_stations/{stationId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.ownerId is string
        && request.resource.data.ownerId == request.auth.uid;

      allow update: if isSignedIn() && (
        // Owner can update everything
        resource.data.ownerId == request.auth.uid
        || isAdmin()
        // ANY authenticated user can update priceReductions and vouchers (for redemptions)
        || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['priceReductions', 'lastUpdated']))
        || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['vouchers', 'lastUpdated']))
        || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['priceReductions', 'vouchers', 'lastUpdated']))
      );
      
      allow delete: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid
        || isAdmin()
      );

      match /ratings/{ratingId} {
        allow read: if true;
        allow create: if isSignedIn()
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.rating is number
          && request.resource.data.createdAt is timestamp;
        allow update, delete: if isSignedIn() && (
          request.auth.uid == resource.data.userId ||
          request.auth.uid == get(/databases/$(database)/documents/gas_stations/$(stationId)).data.ownerId
        );
      }

      match /price_history/{historyId} {
        allow read: if true;
        allow create: if isSignedIn()
          && request.resource.data.timestamp is timestamp;
        allow update, delete: if false;
      }

      match /price_reduction_history/{historyId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
      }

      match /vouchers_redemptions/{redemptionId} {
        // Any signed-in user can read redemptions for this station
        allow read: if isSignedIn();
        
        // User can create redemption records for themselves
        allow create: if isSignedIn() 
          && request.resource.data.voucherId is string
          && request.resource.data.voucherId != ''
          && request.resource.data.stationId == stationId
          && request.resource.data.userId is string
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.claimedAt is timestamp;
        
        // User can delete their own redemptions or station owner can delete
        allow delete: if isSignedIn() && (
          request.auth.uid == resource.data.userId ||
          request.auth.uid == get(/databases/$(database)/documents/gas_stations/$(stationId)).data.ownerId
        );
        
        allow update: if false;
      }
    }

    // --- Station ratings top-level ---
    match /station_ratings/{ratingId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && 
        request.auth.uid == resource.data.userId;
    }

    // --- Comments ---
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.createdAt is timestamp;
      allow update, delete: if isSignedIn() && 
        request.auth.uid == resource.data.userId;
    }

    // --- Vouchers top-level ---
    match /vouchers/{voucherId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.stationId is string
        && request.resource.data.title is string;
      allow update, delete: if isSignedIn() && 
        request.auth.uid == resource.data.ownerId;

      match /redemptions/{userId} {
        allow read: if isSignedIn() && (
          request.auth.uid == userId ||
          resource.data.ownerId == request.auth.uid
        );
        allow create: if isSignedIn() && 
          request.auth.uid == userId
          && request.resource.data.claimedAt is timestamp
          && request.resource.data.voucherId == voucherId;
        allow delete: if isSignedIn() && (
          request.auth.uid == userId ||
          resource.data.ownerId == request.auth.uid
        );
      }
    }

    // --- Approval Tokens ---
    match /approvalTokens/{tokenId} {
      // Allow creation by authenticated users
      allow create: if isSignedIn()
        && request.resource.data.userId is string
        && request.resource.data.userId != ''
        && request.resource.data.createdAt is timestamp
        && request.resource.data.expiresAt is timestamp
        && request.resource.data.used is bool;

      // Allow authenticated users to read tokens they own
      allow read: if isSignedIn()
        && request.auth.uid == resource.data.userId;

      // Allow authenticated users to update their own tokens
      allow update: if isSignedIn()
        && request.auth.uid == resource.data.userId;

      // Allow admins to read and delete
      allow delete: if isAdmin();
    }

    // --- Notifications ---
    match /notifications/{notificationId} {
      // Allow all authenticated users to read notifications (for real-time listener)
      allow read: if isSignedIn();
      
      // Allow authenticated users to create notifications (owners creating offers/vouchers)
      allow create: if isSignedIn()
        && request.resource.data.title is string
        && request.resource.data.body is string
        && request.resource.data.type is string
        && request.resource.data.createdAt is timestamp;
      
      // Allow users to update their own notification read status
      allow update: if isSignedIn()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Don't allow delete (notifications are permanent records)
      allow delete: if false;
    }
  }
}
