rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(ownerId) {
      return isSignedIn() && request.auth.uid == ownerId;
    }

    function isAdmin() {
      // Check if user is admin - adjust based on your admin check logic
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin';
    }

    // --- Users ---
    match /users/{userId} {
      // Allow read if:
      // 1. User is reading their own document
      // 2. User's email matches the authenticated email (when resource exists)
      // 3. Querying by email for verification during signup (limited queries for email checks)
      //    - Allow email existence checks during signup (limit 1, must query by email)
      // 4. Admin reading any user document
      allow read: if isOwner(userId)
        || (isSignedIn() && resource != null && resource.data.email == request.auth.token.email)
        || (isSignedIn() && 
            request.query != null && 
            request.query.limit != null &&
            request.query.limit <= 1 &&
            request.query.where != null &&
            request.query.where.size() >= 1)
        || // Allow email existence check during signup (even without auth for Google signup)
           (request.query != null && 
            request.query.limit != null &&
            request.query.limit <= 1 &&
            request.query.where != null &&
            request.query.where.size() >= 1 &&
            request.query.where[0].field == 'email')
        || isAdmin();

      // Create: user creating their own document during signup
      // Must be authenticated and creating document with their UID
      // OR creating with their email (for email/password signup flow)
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['name', 'email'])
        && request.resource.data.name is string
        && request.resource.data.email is string
        && request.resource.data.email == request.auth.token.email;

      // Update: user can update their own document, admin can update any
      // Allow users to update specific fields during signup/verification flow
      allow update: if isOwner(userId)
        || isAdmin()
        || (isSignedIn() 
            && request.auth.uid == userId 
            && resource != null
            && (
              // Allow updating approval-related fields after document submission
              (request.resource.data.diff(resource.data).affectedKeys().hasAny([
                  'documentsSubmitted', 'emailVerified', 'photoURL', 
                  'stationName', 'stationId', 'stationLat', 'stationLng',
                  'submittedAt', 'verifiedAt', 'authProvider', 'linkedProviders',
                  'googleLinked', 'tempPasswordUsed', 'pendingDocuments',
                  'documentImages', 'documentUrls', 'resubmittedAt', 
                  'resubmissionCount', 'approvalStatus'
                ]))
              // OR allow updating entire document during initial signup/verification
              || (request.resource.data.email == request.auth.token.email)
            ));

      allow delete: if isOwner(userId) || isAdmin();

  // User's claimed offers subcollection
  match /claimed_offers/{claimId} {
    allow read: if isOwner(userId);
    allow create: if isOwner(userId)
      && request.resource.data.offerId is string
      && request.resource.data.offerId != ''
      && request.resource.data.claimedAt is timestamp;
    allow delete: if isOwner(userId);
  }

  // User's redeemed vouchers subcollection
  match /redeemed_vouchers/{redeemedId} {
    allow read: if isOwner(userId);
    allow create: if isOwner(userId)
      && request.resource.data.voucherId is string
      && request.resource.data.voucherId != ''
      && request.resource.data.redeemedAt is timestamp;
    allow delete: if isOwner(userId);
  }
}

    // --- Gas stations ---
    match /gas_stations/{stationId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.ownerId is string
        && request.resource.data.ownerId == request.auth.uid;

      allow update, delete: if (isSignedIn()
        && resource.data.ownerId == request.auth.uid)
        || isAdmin();

      match /ratings/{ratingId} {
        allow read: if true;
        allow create: if isSignedIn()
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.rating is number
          && request.resource.data.createdAt is timestamp;
        allow update, delete: if isSignedIn() && (
          request.auth.uid == resource.data.userId ||
          request.auth.uid == get(/databases/$(database)/documents/gas_stations/$(stationId)).data.ownerId
        );
      }

      match /price_history/{historyId} {
        allow read: if true;
        allow create: if isSignedIn()
          && request.resource.data.timestamp is timestamp;
        allow update, delete: if false;
      }

      match /vouchers_redemptions/{userId} {
        allow read: if isSignedIn() && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/gas_stations/$(stationId)).data.ownerId == request.auth.uid
        );
        allow create: if request.auth.uid == userId
          && request.resource.data.voucherId is string
          && request.resource.data.voucherId != ''
          && request.resource.data.stationId == stationId
          && request.resource.data.claimedAt is timestamp;
        allow delete: if isSignedIn() && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/gas_stations/$(stationId)).data.ownerId == request.auth.uid
        );
        allow update: if false;
      }
    }

    // --- Station ratings top-level ---
    match /station_ratings/{ratingId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // --- Comments ---
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.createdAt is timestamp;
      allow update, delete: if request.auth.uid == resource.data.userId;
    }

    // --- Vouchers top-level ---
    match /vouchers/{voucherId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.stationId is string
        && request.resource.data.title is string;
      allow update, delete: if request.auth.uid == resource.data.ownerId;

      match /redemptions/{userId} {
        allow read: if isSignedIn() && (
          request.auth.uid == userId ||
          resource.data.ownerId == request.auth.uid
        );
        allow create: if request.auth.uid == userId
          && request.resource.data.claimedAt is timestamp
          && request.resource.data.voucherId == voucherId;
        allow delete: if isSignedIn() && (
          request.auth.uid == userId ||
          resource.data.ownerId == request.auth.uid
        );
      }
    }

    // --- Approval Tokens ---
    match /approvalTokens/{tokenId} {
      allow read, write: if false; // Only allow through specific rules below

      // Allow creation of new tokens by authenticated users
      allow create: if isSignedIn()
        && request.resource.data.userId is string
        && request.resource.data.userId != ''
        && request.resource.data.createdAt is timestamp
        && request.resource.data.expiresAt is timestamp
        && request.resource.data.used is bool;

      // Allow system/admin access for token validation and updates
      // This allows the Cloud Function to read and update tokens
      allow read, update: if true;
    }

    // --- Default deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
